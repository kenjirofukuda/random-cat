#+title: Note
#+author: kenjirofukuda@gmail.com
#+options: toc:nil num:nil ^:nil ^:{}
#+HTML_HEAD_EXTRA: <style> .figure p {text-align: left;}</style>
#+HTML_HEAD_EXTRA: <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"></script>


#+begin_example
npx create-next-app random-cat
Need to install the following packages:
  create-next-app@16.0.6
Ok to proceed? (y)
✔ Would you like to use the recommended Next.js defaults? › Yes, use recommended defaults
Creating a new Next.js app in /home/kenjiro/Nextcloud/prove/ts1/random-cat.

Using npm.

Initializing project with template: app-tw


Installing dependencies:
- next
- react
- react-dom

Installing devDependencies:
- @tailwindcss/postcss
- @types/node
- @types/react
- @types/react-dom
- eslint
- eslint-config-next
- tailwindcss
- typescript


added 364 packages, and audited 365 packages in 17s

145 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

Generating route types...
✓ Types generated successfully

Success! Created random-cat at /home/kenjiro/Nextcloud/prove/ts1/random-cat
#+end_example

src/ というフォルダはなく、app がソースディレクトリとなる。

apiを使う。
#+begin_example
https://api.thecatapi.com/v1/images/search
#+end_example


#+begin_src json
[
 {
  "id": "MTc5NTg1Mg",
  "url": "https://cdn2.thecatapi.com/images/MTc5NTg1Mg.jpg",
  "width": 1394,
  "height": 1394
  }
 ]
 #+end_src

基本の呼び出し方
#+begin_src javascript
const headers = new Headers({
  "Content-Type": "application/json",
  "x-api-key": "DEMO-API-KEY"
});

var requestOptions = {
  method: 'GET',
  headers: headers,
  redirect: 'follow'
};

fetch("https://api.thecatapi.com/v1/images/search?size=med&mime_types=jpg&format=json&has_breeds=true&order=RANDOM&page=0&limit=1", requestOptions)
  .then(response => response.text())
  .then(result => console.log(result))
  .catch(error => console.log('error', error));
#+end_src

開発ツールのおすすめがメーセージとして現れる
#+begin_example
Download the React DevTools for a better development experience:
https://react.dev/link/react-devtools
#+end_example

useStateはクライアントサイドの機能なので、コンポーネントの先頭に"use client"というディレクティブを追加する必要があります。詳しくは後述します。

JSX内に文はかけない式のみである。


* 展開されたfetch-image.ts (抜粋)

まだ、"use server"を用いてないのでクライアントとして展開されている

#+begin_src javascript
(globalThis.TURBOPACK || (globalThis.TURBOPACK = [])).push([typeof document === "object" ? document.currentScript : undefined,
"[project]/app/fetch-image.ts [app-client] (ecmascript)", ((__turbopack_context__) => {
"use strict";

// 画像情報の型定義
__turbopack_context__.s([
    "fetchImage",
    ()=>fetchImage
]);
async function fetchImage() {
    //                                ^^^^^^^^^^^^^^ 型注釈を追加
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const images = await res.json();
    if (!isImageArray(images)) {
        throw new Error("取得したデータが正しくありません");
    }
    if (!isImage(images[0])) {
        throw new Error("取得したデータが空です");
    }
    console.log("fetchImages: 画像情報を取得しました。", images);
    return images[0]; // 画像情報の配列から最初の要素を返す。
}
// Image型の配列であるかチェックする関数
function isImageArray(value) {
    // valueが配列であること
    if (!Array.isArray(value)) {
        return false;
    }
    // 配列の要素すべてがImage型であること
    if (!value.every(isImage)) {
        return false;
    }
    return true;
}
// Image型であるかをチェックする関数
function isImage(value) {
    // valueがオブジェクトであること
    if (typeof value !== "object" || value === null) {
        return false;
    }
    // valueにurlフィールドがあること
    if (!("url" in value)) {
        return false;
    }
    // urlフィールドが文字列であること
    if (typeof value.url !== "string") {
        return false;
    }
    return true;
}
if (typeof globalThis.$RefreshHelpers$ === 'object' && globalThis.$RefreshHelpers !== null) {
    __turbopack_context__.k.registerExports(__turbopack_context__.m, globalThis.$RefreshHelpers$);
}
}),
#+end_src


page [.tsx]
page [.module.css]
この規約にファイル名を従わせると、cssのクラス名をオブジェクトとして扱うことが可能。

import 名で装飾することで、同じクラス名の衝突を避けることができる。

#+begin_src javascript
import { a } from "./a.module.css";
import { b } from "./b.module.css";
// ...
<button className={a.button} />
<button className={b.button} />
#+end_src

* スタイルが反映されない原因

#+begin_src diff
< <div className="{styles.page}">
---
> <div className={styles.page}>
#+end_src>
余分なクオートが変数展開を阻害していた


* tsx 編集環境

- https://joppot.info/posts/c05e989a-e642-4c84-a5b8-a0e0c3178941

* プロダクションビルド

#+begin_example
$ npm run build

> random-cat@0.1.0 build
> next build

   ▲ Next.js 16.0.6 (Turbopack)
   - Environments: .env

   Creating an optimized production build ...
 ✓ Compiled successfully in 7.6s
 ✓ Finished TypeScript in 1655.8ms    
 ✓ Collecting page data using 11 workers in 547.2ms    
 ✓ Generating static pages using 11 workers (4/4) in 624.6ms
 ✓ Finalizing page optimization in 12.5ms    

Route (app)
┌ ƒ /
└ ○ /_not-found


○  (Static)   prerendered as static content
ƒ  (Dynamic)  server-rendered on demand

#+end_example


* ディレクトリレイアウト
#+begin_src bash :results raw
 tree -L 3 --gitignore
#+end_src

#+begin_example
.
├── app
│   ├── cat-image.tsx
│   ├── env.ts
│   ├── favicon.ico
│   ├── fetch-image.ts
│   ├── globals.css
│   ├── layout.tsx
│   ├── page.module.css
│   └── page.tsx
├── eslint.config.mjs
├── next.config.ts
├── Note.org
├── package.json
├── package-lock.json
├── postcss.config.mjs
├── public
│   ├── file.svg
│   ├── globe.svg
│   ├── next.svg
│   ├── vercel.svg
│   └── window.svg
├── README.md
└── tsconfig.json

3 directories, 21 files
#+end_example

